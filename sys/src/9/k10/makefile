CC=gcc
LD=gcc
O=o
AS=as
objtype=amd64


INC_DIR=/sys/include
INCX86_64_DIR=/$(objtype)/include
LIB_DIR=/$(objtype)/lib
WARNFLAGS=-Wall' '-Wno-missing-braces' '-Wno-parentheses' '-Wno-unknown-pragmas' '-Wuninitialized' '-Wmaybe-uninitialized
LDFLAGS=-L$(LIB_DIR)

#OS=568qv
OS=o
#CPUS=arm amd64 386 power mips
CPUS=amd64
#CFLAGS=-FTVw
CFLAGS=-O0 -static -fplan9-extensions -ffreestanding -fno-builtin -Wall -Wno-missing-braces -Wno-parentheses -Wno-unknown-pragmas -Wuninitialized -Wmaybe-uninitialized -I$(INCX86_64_DIR) -I$(INC_DIR) -I.
LEX=lex
YACC=yacc

OBJECTS=$(SOURCES:.c=.o)

all: 9k8cpu

9k8cpu: mach dev port

mach: acore.o arch.o archk10.o asm.o cga.o crap.o fpu.o i8254.o i8259.o ../386/kbd.o main.o map.o memory.o mmu.o multiboot.o qmalloc.o ../386/random.o syscall.o tcore.o trap.o vsvm.o physalloc.o

dev: ../386/ether8169.o ../386/devrtc.o ../port/netif.o ../port/devssl.o ../ip/ip.o ../ip/ipv6.o ../386/pci.o ether82563.o ../ip/devip.o ../port/devuart.o ../port/ethermii.o ../386/etherigbe.o ../port/devproc.o ../port/devkprof.o ../ip/netlog.o ../ip/nullmedium.o ../386/ether82557.o ../ip/tcp.o ioapic.o ../port/devsrv.o ../ip/ipaux.o ../port/devpci.o ../port/devenv.o ../port/devdup.o ../port/devpipe.o ../ip/arp.o ../386/uartpci.o mp.o msi.o pmcio.o ../port/devsegment.o ../ip/icmp.o ../ip/icmp6.o ../ip/ptclbsum.o ../ip/ethermedium.o ../ip/ipifc.o ../386/devether.o ../386/uarti8250.o ../ip/iproute.o devarch.o ../ip/inferno.o ../port/devmnt.o devacpi.o ../ip/chandial.o ../ip/netdevmedium.o apic.o ../port/devcap.o ../port/devws.o ../ip/loopbackmedium.o ../port/devcons.o ../ip/pktmedium.o ../ip/udp.o ../port/devzp.o ../port/devroot.o ../port/devpmc.o

port: ../port/tod.o ../port/sysauth.o ../port/pager.o ../port/edf.o ../port/latin1.o ../port/syszio.o ../port/segment.o ../port/allocb.o systab.o ../port/qio.o ../port/proc.o ../port/ps.o ../port/fault.o ../port/image.o ../port/page.o ../port/sysseg.o ../port/parse.o ../port/devtab.o ../port/syssem.o ../port/dev.o ../port/rebootcmd.o ../port/sysproc.o ../port/portclock.o ../port/chan.o ../port/syscallfmt.o ../port/pgrp.o ../port/qlock.o ../port/alarm.o ../port/print.o ../port/sysfile.o ../port/taslock.o

#In dev must be sipi.o, but needs sipi.h generated by dumping l64sipi.out binary from l64sipi.s not available for now

.c.o:
	$(CC) $(CFLAGS) -c $< -o $@

main.o: init.h

init.h: init.out
	./dumpinith.sh

init.out: init9.o ../port/initcode.o /$(objtype)/lib/libc.a
#	$(CC) $(CFLAGS) -o init.out init9.o ../port/initcode.o -L/$(objtype)/lib/libc.a
	/usr/lib/gcc/x86_64-linux-gnu/4.9/collect2  -plugin /usr/lib/gcc/x86_64-linux-gnu/4.9/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/4.9/lto-wrapper --sysroot=/ --build-id -m elf_x86_64 --hash-style=gnu -static -o init.out init9.o ../port/initcode.o -L/$(objtype)/lib -lc

systab.o:
	awk -f ../mk/parse -- -mksystab /sys/src/libc/9syscall/sys.h k8cpu > systab.c
	$(CC) $(CFLAGS) -c systab.c
errstr.h:
	awk -f ../mk/parse -- -mkerrstr k8cpu > errstr.h
proc.o: errstr.h
	$(CC) $(CFLAGS) -c ../port/proc.c

clean:
	rm *.o init.h ../386/*.o ../port/*.o ../ip/*.o systab.c errstr.h

