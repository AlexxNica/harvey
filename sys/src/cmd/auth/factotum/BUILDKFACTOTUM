#!/bin/bash
set -e

CC=gcc
CFLAGS="-mcmodel=small -O0 -fplan9-extensions -ffreestanding -fno-builtin -Wall -Wno-missing-braces -Wno-parentheses -Wno-unknown-pragmas -Wuninitialized -Wmaybe-uninitialized -I/amd64/include -I/sys/include -c -g "
LIB_DIR="/amd64/lib"
LDFLAGS=-L${LIB_DIR}
LD=ld

rm -f *.o
$CC $CFLAGS -c \
apop.c \
chap.c \
confirm.c \
fs.c \
httpdigest.c \
log.c \
p9any.c \
p9cr.c \
p9sk1.c \
pass.c \
rpc.c \
rsa.c \
secstore.c \
util.c \
wep.c \
hack.S \

echo "linking.."
echo
$LD -static -o factotum.elf.out *.o $LDFLAGS -l9p -lauth -lauthsrv -lndb -lsec -lString -lthread -lmp -lip -lc -emain -Ttext=0x200020

$CC $CFLAGS -c fgui.c 
$LD -static -o fgui.elf.out fgui.o $LDFLAGS -lcontrol -ldraw -l9p -lauth -lauthsrv -lndb -lsec -lString -lthread -lmp -lip -lc -emain -Ttext=0x200020
rm *.o
